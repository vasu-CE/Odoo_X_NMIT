// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  loginId   String   @unique
  email     String   @unique
  name      String
  password  String
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedManufacturingOrders ManufacturingOrder[] @relation("ManufacturingOrderAssignee")
  createdManufacturingOrders ManufacturingOrder[] @relation("ManufacturingOrderCreator")
  workOrders         WorkOrder[]
  createdBOMs        BOM[]

  @@map("users")
}

model Product {
  id            Int         @id @default(autoincrement())
  name          String
  description   String?
  type          ProductType
  unit          String      @default("PCS")
  salesPrice    Float?
  purchasePrice Float?
  currentStock  Int         @default(0)
  reorderPoint  Int         @default(0)
  hsnCode       String?
  category      String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  boms                BOM[]
  bomComponents       BOMComponent[]
  stockMovements      StockMovement[]
  manufacturingOrders ManufacturingOrder[]

  @@map("products")
}

model BOM {
  id              Int       @id @default(autoincrement())
  productId       Int?      // Made optional for new structure
  finished_product String   @default("") // New field for finished product name
  quantity        Float     @default(1) // New field for quantity
  reference       String?   // New field for reference
  version         String    @default("1.0")
  isActive        Boolean   @default(true)
  createdById     Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  product            Product?             @relation(fields: [productId], references: [id])
  createdBy          User                @relation(fields: [createdById], references: [id])
  components         BOMComponent[]
  operations         BOMOperation[]
  manufacturingOrders ManufacturingOrder[]

  @@unique([productId, version])
  @@map("boms")
}

model BOMComponent {
  id        Int     @id @default(autoincrement())
  bomId     Int
  productId Int
  quantity  Float
  unit      String  @default("PCS")
  wastage   Float   @default(0)

  // Relations
  bom     BOM     @relation(fields: [bomId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("bom_components")
}

model BOMOperation {
  id           Int    @id @default(autoincrement())
  bomId        Int
  sequence     Int
  name         String
  description  String?
  timeMinutes  Int
  workCenterId Int

  // Relations
  bom        BOM        @relation(fields: [bomId], references: [id], onDelete: Cascade)
  workCenter WorkCenter @relation(fields: [workCenterId], references: [id])

  @@map("bom_operations")
}

model WorkCenter {
  id           Int               @id @default(autoincrement())
  name         String
  description  String?
  hourlyRate   Float
  capacity     Int               @default(1)
  status       WorkCenterStatus  @default(ACTIVE)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // Relations
  operations BOMOperation[]
  workOrders WorkOrder[]

  @@map("work_centers")
}

model ManufacturingOrder {
  id              Int                  @id @default(autoincrement())
  orderNumber     String               @unique
  finishedProduct String               // Product name/description
  productId       Int?                 // Reference to Product table
  quantity        Int
  units           String               @default("PCS")
  status          ManufacturingStatus  @default(DRAFT)
  priority        Priority             @default(MEDIUM)
  scheduleDate    DateTime
  startedAt       DateTime?
  completedAt     DateTime?
  assigneeId      Int?                 // Renamed from assignedToId
  createdById     Int                  // Who created this MO
  bomId           Int?
  estimatedCost   Float?
  actualCost      Float?
  notes           String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Relations
  assignee        User?                @relation("ManufacturingOrderAssignee", fields: [assigneeId], references: [id])
  createdBy       User                 @relation("ManufacturingOrderCreator", fields: [createdById], references: [id])
  product         Product?             @relation(fields: [productId], references: [id])
  bom             BOM?                 @relation(fields: [bomId], references: [id])
  components      Component[]
  workOrders      WorkOrder[]

  @@map("manufacturing_orders")
}

model Component {
  id                  Int     @id @default(autoincrement())
  manufacturingOrderId Int
  componentName       String
  availability        Float
  toConsume           Float
  consumed            Float   @default(0)
  units               String  @default("PCS")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  manufacturingOrder  ManufacturingOrder @relation(fields: [manufacturingOrderId], references: [id], onDelete: Cascade)

  @@map("components")
}

model WorkOrder {
  id                     Int               @id @default(autoincrement())
  manufacturingOrderId   Int
  operationName          String
  workCenterName         String
  workCenterId           Int?              // Reference to WorkCenter table
  plannedDuration        Int               // in minutes
  realDuration           Int?              // in minutes
  status                 WorkOrderStatus   @default(PENDING)
  assignedToId           Int?
  estimatedTimeMinutes   Int
  actualTimeMinutes      Int?
  startTime              DateTime?
  endTime                DateTime?
  // realDuration           Int?              // Duration in minutes (endTime - startTime - pausedDuration)  
  pausedDuration         Int?              @default(0) // Total paused duration in minutes
  pausedAt               DateTime?
  completedAt            DateTime?
  comments               String?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  // Relations
  manufacturingOrder ManufacturingOrder @relation(fields: [manufacturingOrderId], references: [id], onDelete: Cascade)
  workCenter         WorkCenter?        @relation(fields: [workCenterId], references: [id])
  assignedTo         User?              @relation(fields: [assignedToId], references: [id])

  @@map("work_orders")
}

model StockMovement {
  id              Int          @id @default(autoincrement())
  productId       Int
  movementType    MovementType
  quantity        Int
  unitCost        Float?
  totalValue      Float?
  reference       String?
  referenceId     String?
  notes           String?
  transactionDate DateTime     @default(now())
  createdAt       DateTime     @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@map("stock_movements")
}

// Enums
enum UserRole {
  ADMIN
  MANUFACTURING_MANAGER
  SHOP_FLOOR_OPERATOR
  INVENTORY_MANAGER
  BUSINESS_OWNER
}

enum ProductType {
  RAW_MATERIAL
  WIP
  FINISHED_GOOD
  CONSUMABLE
}

enum WorkCenterStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
}

enum ManufacturingStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS
  TO_CLOSE
  DONE
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum MovementType {
  IN
  OUT
  TRANSFER
  ADJUSTMENT
}
